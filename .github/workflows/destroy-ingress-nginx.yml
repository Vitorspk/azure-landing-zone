name: Destroy Ingress NGINX

on:
  workflow_dispatch:
    inputs:
      clusters:
        description: 'Which clusters to destroy Ingress NGINX'
        required: true
        type: choice
        options:
          - all
          - dev
          - stg
          - prd
          - sdx
          - dev,stg
      ingress_type:
        description: 'Which Ingress type to destroy'
        required: true
        type: choice
        default: 'both'
        options:
          - both
          - external
          - internal
      confirm:
        description: 'Type "yes" to confirm destruction'
        required: true
        type: string

env:
  AZURE_REGION: brazilsouth
  RESOURCE_GROUP: rg-network

jobs:
  destroy-ingress:
    name: Destroy Ingress NGINX
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "yes" ]; then
            echo "‚ùå Destruction not confirmed. Please type 'yes' to confirm."
            exit 1
          fi
          echo "‚úÖ Destruction confirmed"
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Parse clusters input
        id: parse_clusters
        run: |
          CLUSTERS_INPUT="${{ github.event.inputs.clusters }}"
          
          if [ "$CLUSTERS_INPUT" == "all" ]; then
            CLUSTERS="dev stg prd sdx"
          else
            CLUSTERS=$(echo "$CLUSTERS_INPUT" | tr ',' ' ')
          fi
          
          echo "clusters=$CLUSTERS" >> $GITHUB_OUTPUT
          echo "üìã Clusters to process: $CLUSTERS"
      
      - name: Destroy Ingress NGINX
        env:
          CLUSTERS: ${{ steps.parse_clusters.outputs.clusters }}
          INGRESS_TYPE: ${{ github.event.inputs.ingress_type }}
        run: |
          echo "=================================================="
          echo "üóëÔ∏è  Ingress NGINX Destruction"
          echo "=================================================="
          echo ""
          echo "Clusters: $CLUSTERS"
          echo "Ingress Type: $INGRESS_TYPE"
          echo ""
          
          # Counters
          TOTAL=0
          SUCCESS=0
          FAILED=0
          
          for ENV in $CLUSTERS; do
            CLUSTER_NAME="aks-${ENV}"
            TOTAL=$((TOTAL + 1))
            
            echo ""
            echo "=================================================="
            echo "üìç Processing Cluster: $CLUSTER_NAME"
            echo "=================================================="
            echo ""
            
            # Check if cluster exists
            if ! az aks show --name "$CLUSTER_NAME" --resource-group $RESOURCE_GROUP &>/dev/null; then
              echo "‚ö†Ô∏è  Cluster $CLUSTER_NAME does not exist. Skipping..."
              SUCCESS=$((SUCCESS + 1))
              continue
            fi
            
            echo "‚úÖ Cluster $CLUSTER_NAME exists"
            
            # Get kubeconfig
            echo "üîó Connecting to cluster..."
            if ! az aks get-credentials --name "$CLUSTER_NAME" --resource-group $RESOURCE_GROUP --overwrite-existing; then
              echo "‚ùå Failed to connect to cluster $CLUSTER_NAME"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            echo "‚úÖ Connected to $CLUSTER_NAME"
            
            # Delete External Ingress
            if [ "$INGRESS_TYPE" == "both" ] || [ "$INGRESS_TYPE" == "external" ]; then
              echo ""
              echo "üåê Destroying External Ingress..."
              echo ""
              
              # Delete manifest resources
              kubectl delete -f manifests/aks-ingress-nginx-1.13.3-external.yaml --ignore-not-found 2>&1 || echo "‚ö†Ô∏è  Some resources not found"
              
              # Explicitly delete IngressClass (cluster-scoped resource)
              echo "üßπ Deleting External IngressClass..."
              kubectl delete ingressclass nginx --ignore-not-found 2>/dev/null || true
              kubectl delete ingressclass nginx-external --ignore-not-found 2>/dev/null || true
              
              # Force delete stuck resources
              echo "üßπ Cleaning up External namespace..."
              
              # Delete Jobs
              kubectl delete job --all -n ingress-nginx-external --ignore-not-found --force --grace-period=0 2>/dev/null || true
              
              # Delete Pods
              kubectl delete pods --all -n ingress-nginx-external --ignore-not-found --force --grace-period=0 2>/dev/null || true
              
              # Remove finalizers if namespace is stuck
              kubectl get namespace ingress-nginx-external -o json 2>/dev/null | \
                jq '.spec.finalizers = []' | \
                kubectl replace --raw "/api/v1/namespaces/ingress-nginx-external/finalize" -f - 2>/dev/null || true
              
              # Wait for namespace deletion
              echo "‚è≥ Waiting for External namespace deletion..."
              kubectl wait --for=delete namespace/ingress-nginx-external --timeout=60s 2>/dev/null || echo "‚ö†Ô∏è  Namespace may still be terminating"
              
              echo "‚úÖ External Ingress destroyed"
            fi
            
            # Delete Internal Ingress
            if [ "$INGRESS_TYPE" == "both" ] || [ "$INGRESS_TYPE" == "internal" ]; then
              echo ""
              echo "üîí Destroying Internal Ingress..."
              echo ""
              
              # Delete manifest resources
              kubectl delete -f manifests/aks-ingress-nginx-1.13.3-internal.yaml --ignore-not-found 2>&1 || echo "‚ö†Ô∏è  Some resources not found"
              
              # Explicitly delete IngressClass (cluster-scoped resource)
              echo "üßπ Deleting Internal IngressClass..."
              kubectl delete ingressclass nginx-internal --ignore-not-found 2>/dev/null || true
              
              # Force delete stuck resources
              echo "üßπ Cleaning up Internal namespace..."
              
              # Delete Jobs
              kubectl delete job --all -n ingress-nginx-internal --ignore-not-found --force --grace-period=0 2>/dev/null || true
              
              # Delete Pods
              kubectl delete pods --all -n ingress-nginx-internal --ignore-not-found --force --grace-period=0 2>/dev/null || true
              
              # Remove finalizers if namespace is stuck
              kubectl get namespace ingress-nginx-internal -o json 2>/dev/null | \
                jq '.spec.finalizers = []' | \
                kubectl replace --raw "/api/v1/namespaces/ingress-nginx-internal/finalize" -f - 2>/dev/null || true
              
              # Wait for namespace deletion
              echo "‚è≥ Waiting for Internal namespace deletion..."
              kubectl wait --for=delete namespace/ingress-nginx-internal --timeout=60s 2>/dev/null || echo "‚ö†Ô∏è  Namespace may still be terminating"
              
              echo "‚úÖ Internal Ingress destroyed"
            fi
            
            # Verify deletion
            echo ""
            echo "üîç Verifying deletion..."
            echo ""
            
            if [ "$INGRESS_TYPE" == "both" ] || [ "$INGRESS_TYPE" == "external" ]; then
              if kubectl get namespace ingress-nginx-external &>/dev/null; then
                echo "‚ö†Ô∏è  External namespace still exists (may be terminating)"
              else
                echo "‚úÖ External namespace deleted"
              fi
            fi
            
            if [ "$INGRESS_TYPE" == "both" ] || [ "$INGRESS_TYPE" == "internal" ]; then
              if kubectl get namespace ingress-nginx-internal &>/dev/null; then
                echo "‚ö†Ô∏è  Internal namespace still exists (may be terminating)"
              else
                echo "‚úÖ Internal namespace deleted"
              fi
            fi
            
            SUCCESS=$((SUCCESS + 1))
          done
          
          echo ""
          echo "=================================================="
          echo "üìä Summary"
          echo "=================================================="
          echo ""
          echo "Total clusters processed: $TOTAL"
          echo "Successful: $SUCCESS"
          echo "Failed: $FAILED"
          echo ""
          
          if [ $FAILED -gt 0 ]; then
            echo "‚ö†Ô∏è  Some clusters failed. Check logs above."
            exit 1
          else
            echo "‚úÖ All clusters processed successfully!"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "üìã Destruction Summary"
          echo "=================================================="
          echo ""
          echo "Workflow: Ingress NGINX Destruction"
          echo "Clusters: ${{ github.event.inputs.clusters }}"
          echo "Ingress Type: ${{ github.event.inputs.ingress_type }}"
          echo "Status: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Destruction completed successfully!"
            echo ""
            echo "‚ö†Ô∏è  Note: Azure Load Balancers may take a few minutes to be fully removed."
          else
            echo "‚ùå Destruction failed. Check logs above."
          fi
          echo ""
