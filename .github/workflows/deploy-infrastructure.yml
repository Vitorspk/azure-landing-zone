name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to deploy'
        required: true
        type: choice
        options:
          - 'all'
          - '00-iam'
          - '01-networking'
          - '02-kubernetes'
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - 'plan'
          - 'apply'
          - 'destroy'
      clusters:
        description: 'Which clusters to deploy (for kubernetes module only)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'dev'
          - 'stg'
          - 'prd'
          - 'sdx'
          - 'dev,stg'
          - 'dev,stg,prd'

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Module
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          set +e  # Don't exit on error, we'll handle it
          
          # Main deployment logic
          if [ "${{ github.event.inputs.module }}" == "all" ]; then
            # Deploy all modules sequentially
            for module in 00-iam 01-networking 02-kubernetes; do
              echo "========================================"
              echo "Deploying module: $module"
              echo "========================================"
              cd terraform/$module
              
              terraform init
              
              # Handle different actions
              case "${{ github.event.inputs.action }}" in
                plan)
                  if [ "$module" == "02-kubernetes" ]; then
                    terraform plan -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                  else
                    terraform plan
                  fi
                  ;;
                  
                apply)
                  # Attempt apply and capture output
                  if [ "$module" == "02-kubernetes" ]; then
                    APPLY_OUTPUT=$(terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}" 2>&1)
                  else
                    APPLY_OUTPUT=$(terraform apply -auto-approve 2>&1)
                  fi
                  
                  APPLY_EXIT=$?
                  echo "$APPLY_OUTPUT"
                  
                  # Check if error is "already exists"
                  if [ $APPLY_EXIT -ne 0 ]; then
                    if echo "$APPLY_OUTPUT" | grep -q "already exists.*needs to be imported"; then
                      echo ""
                      echo "‚ö†Ô∏è  'Already Exists' error detected!"
                      echo "üìã Extracting resource information from error..."
                      
                      # Extract resource address and ID from error
                      RESOURCE_TYPE=$(echo "$APPLY_OUTPUT" | grep -oP 'with \K[^,]+' | head -1 | tr -d ' ')
                      RESOURCE_ID=$(echo "$APPLY_OUTPUT" | grep -oP 'ID "\K[^"]+' | head -1)
                      
                      if [ -n "$RESOURCE_TYPE" ] && [ -n "$RESOURCE_ID" ]; then
                        echo "  Resource: $RESOURCE_TYPE"
                        echo "  ID: $RESOURCE_ID"
                        echo ""
                        echo "üîÑ Attempting to import..."
                        
                        if terraform import "$RESOURCE_TYPE" "$RESOURCE_ID"; then
                          echo "‚úÖ Import successful! Retrying apply..."
                          
                          # Retry apply
                          if [ "$module" == "02-kubernetes" ]; then
                            terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                          else
                            terraform apply -auto-approve
                          fi
                          
                          if [ $? -eq 0 ]; then
                            echo "‚úÖ Apply successful after import!"
                          else
                            echo "‚ùå Apply failed after import"
                            exit 1
                          fi
                        else
                          echo "‚ùå Import failed"
                          echo ""
                          echo "üí° Manual fix needed:"
                          echo "   az group delete --name rg-network --yes --no-wait"
                          echo "   Then re-run this workflow"
                          exit 1
                        fi
                      else
                        echo "‚ùå Could not extract resource information from error"
                        echo ""
                        echo "üí° Manual fix needed:"
                        echo "   az group delete --name rg-network --yes --no-wait"
                        echo "   Then re-run this workflow"
                        exit 1
                      fi
                    else
                      # Different error
                      echo "‚ùå Terraform apply failed with non-import error"
                      exit 1
                    fi
                  fi
                  ;;
                  
                destroy)
                  if [ "$module" == "02-kubernetes" ]; then
                    terraform destroy -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                  else
                    terraform destroy -auto-approve
                  fi
                  ;;
              esac
              
              cd ../..
            done
          else
            # Deploy single module
            echo "========================================"
            echo "Deploying module: ${{ github.event.inputs.module }}"
            echo "========================================"
            cd terraform/${{ github.event.inputs.module }}
            
            terraform init
            
            # Handle different actions
            case "${{ github.event.inputs.action }}" in
              plan)
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  terraform plan -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                else
                  terraform plan
                fi
                ;;
                
              apply)
                # Attempt apply and capture output
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  APPLY_OUTPUT=$(terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}" 2>&1)
                else
                  APPLY_OUTPUT=$(terraform apply -auto-approve 2>&1)
                fi
                
                APPLY_EXIT=$?
                echo "$APPLY_OUTPUT"
                
                # Check if error is "already exists"
                if [ $APPLY_EXIT -ne 0 ]; then
                  if echo "$APPLY_OUTPUT" | grep -q "already exists.*needs to be imported"; then
                    echo ""
                    echo "‚ö†Ô∏è  'Already Exists' error detected!"
                    echo "üìã Extracting resource information from error..."
                    
                    # Extract resource address and ID from error
                    RESOURCE_TYPE=$(echo "$APPLY_OUTPUT" | grep -oP 'with \K[^,]+' | head -1 | tr -d ' ')
                    RESOURCE_ID=$(echo "$APPLY_OUTPUT" | grep -oP 'ID "\K[^"]+' | head -1)
                    
                    if [ -n "$RESOURCE_TYPE" ] && [ -n "$RESOURCE_ID" ]; then
                      echo "  Resource: $RESOURCE_TYPE"
                      echo "  ID: $RESOURCE_ID"
                      echo ""
                      echo "üîÑ Attempting to import..."
                      
                      if terraform import "$RESOURCE_TYPE" "$RESOURCE_ID"; then
                        echo "‚úÖ Import successful! Retrying apply..."
                        
                        # Retry apply
                        if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                          terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                        else
                          terraform apply -auto-approve
                        fi
                        
                        if [ $? -eq 0 ]; then
                          echo "‚úÖ Apply successful after import!"
                        else
                          echo "‚ùå Apply failed after import"
                          exit 1
                        fi
                      else
                        echo "‚ùå Import failed"
                        echo ""
                        echo "üí° Quick fix:"
                        echo "   az group delete --name rg-network --yes --no-wait"
                        echo "   Wait 3 minutes, then re-run this workflow"
                        exit 1
                      fi
                    else
                      echo "‚ùå Could not extract resource information from error"
                      echo ""
                      echo "üí° Quick fix:"
                      echo "   az group delete --name rg-network --yes --no-wait"
                      echo "   Wait 3 minutes, then re-run this workflow"
                      exit 1
                    fi
                  else
                    # Different error
                    echo "‚ùå Terraform apply failed"
                    exit 1
                  fi
                fi
                ;;
                
              destroy)
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  terraform destroy -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                else
                  terraform destroy -auto-approve
                fi
                ;;
            esac
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Module: ${{ github.event.inputs.module }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Clusters: ${{ github.event.inputs.clusters }}"
          echo "Status: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              echo "‚úÖ Planning completed successfully!"
              echo ""
              echo "Review the plan above. If OK:"
              echo "  Run workflow again with action: apply"
            else
              echo "‚úÖ Infrastructure deployment completed successfully!"
              echo ""
              echo "Resources are now live in Azure."
            fi
          else
            echo "‚ùå Deployment failed."
            echo ""
            echo "üí° If you saw 'already exists' error, quickest fix:"
            echo "   1. Run: az group delete --name rg-network --yes --no-wait"
            echo "   2. Wait 3 minutes"
            echo "   3. Re-run this workflow"
            echo ""
            echo "üìö For permanent solution, see README.md 'Remote State Backend' section"
          fi
          echo ""
