name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to deploy'
        required: true
        type: choice
        options:
          - 'all'
          - '00-iam'
          - '01-networking'
          - '02-kubernetes'
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - 'plan'
          - 'apply'
          - 'destroy'
      clusters:
        description: 'Which clusters to deploy (for kubernetes module only)'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'dev'
          - 'stg'
          - 'prd'
          - 'sdx'
          - 'dev,stg'
          - 'dev,stg,prd'
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction of resources'
        required: false
        type: string
        default: ''

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Inputs
        run: |
          # Validate clusters parameter for kubernetes module
          if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ] || [ "${{ github.event.inputs.module }}" == "all" ]; then
            if [ -z "${{ github.event.inputs.clusters }}" ]; then
              echo "‚ùå ERROR: clusters parameter cannot be empty for kubernetes module"
              exit 1
            fi
          fi
          
          # Validate destroy confirmation
          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
              echo "‚ùå ERROR: You must type 'DESTROY' to confirm resource destruction"
              echo "This is a safety check to prevent accidental deletion."
              exit 1
            fi
            
            # Extra warning for production
            if [ "${{ github.event.inputs.clusters }}" == "prd" ] || [ "${{ github.event.inputs.clusters }}" == "all" ]; then
              echo "‚ö†Ô∏è  WARNING: You are about to destroy PRODUCTION resources!"
              echo "This action is irreversible."
            fi
          fi

      - name: Deploy Module
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          set +e  # Don't exit on error, we'll handle it
          
          # Main deployment logic
          if [ "${{ github.event.inputs.module }}" == "all" ]; then
            # Deploy all modules sequentially
            for module in 00-iam 01-networking 02-kubernetes; do
              echo "========================================"
              echo "Deploying module: $module"
              echo "========================================"
              cd terraform/$module
              
              terraform init
              
              # Handle different actions
              case "${{ github.event.inputs.action }}" in
                plan)
                  if [ "$module" == "02-kubernetes" ]; then
                    terraform plan -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                  else
                    terraform plan
                  fi
                  ;;
                  
                apply)
                  # Attempt apply and capture output
                  if [ "$module" == "02-kubernetes" ]; then
                    APPLY_OUTPUT=$(terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}" 2>&1)
                  else
                    APPLY_OUTPUT=$(terraform apply -auto-approve 2>&1)
                  fi
                  
                  APPLY_EXIT=$?
                  echo "$APPLY_OUTPUT"
                  
                  # Check if error is "already exists"
                  if [ $APPLY_EXIT -ne 0 ]; then
                    if echo "$APPLY_OUTPUT" | grep -q "already exists.*needs to be imported"; then
                      echo ""
                      echo "‚ö†Ô∏è  'Already Exists' error detected!"
                      echo "üìã Multiple resources may need to be imported..."
                      echo ""
                      
                      # Extract ALL resources that need import
                      RESOURCES_TO_IMPORT=$(echo "$APPLY_OUTPUT" | grep -oP 'with \K[a-z_]+\.[a-z_]+(\[[^\]]+\])?' | sort -u)
                      RESOURCE_COUNT=$(echo "$RESOURCES_TO_IMPORT" | wc -l)
                      
                      echo "Found $RESOURCE_COUNT resource(s) that need import:"
                      echo "$RESOURCES_TO_IMPORT"
                      echo ""
                      
                      if [ $RESOURCE_COUNT -gt 5 ]; then
                        echo "‚ùå Too many resources to auto-import ($RESOURCE_COUNT resources)"
                        echo ""
                        echo "üí° This indicates orphaned resources from previous deployments."
                        echo "Quickest solution:"
                        echo "   1. az group delete --name rg-network --yes --no-wait"
                        echo "   2. Wait 3-5 minutes"
                        echo "   3. Re-run this workflow"
                        exit 1
                      fi
                      
                      # Try to import each resource
                      IMPORT_SUCCESS=true
                      while IFS= read -r RESOURCE_ADDRESS; do
                        if [ -z "$RESOURCE_ADDRESS" ]; then
                          continue
                        fi
                        
                        # Extract ID for this specific resource
                        RESOURCE_ID=$(echo "$APPLY_OUTPUT" | grep -A 2 "with $RESOURCE_ADDRESS" | grep -oP 'ID "\K[^"]+' | head -1)
                        
                        if [ -z "$RESOURCE_ID" ]; then
                          echo "‚ùå Failed to extract ID for: $RESOURCE_ADDRESS"
                          IMPORT_SUCCESS=false
                          continue
                        fi
                        
                        echo "üîÑ Importing: $RESOURCE_ADDRESS"
                        echo "   ID: $RESOURCE_ID"
                        
                        if terraform import "$RESOURCE_ADDRESS" "$RESOURCE_ID"; then
                          echo "‚úÖ Imported successfully!"
                        else
                          echo "‚ùå Import failed for: $RESOURCE_ADDRESS"
                          IMPORT_SUCCESS=false
                        fi
                        echo ""
                      done <<< "$RESOURCES_TO_IMPORT"
                      
                      if [ "$IMPORT_SUCCESS" = true ]; then
                        echo "‚úÖ All resources imported! Retrying apply..."
                        echo ""
                        
                        # Retry apply
                        if [ "$module" == "02-kubernetes" ]; then
                          terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                        else
                          terraform apply -auto-approve
                        fi
                        
                        if [ $? -eq 0 ]; then
                          echo "‚úÖ Apply successful after import!"
                        else
                          echo "‚ùå Apply failed after import"
                          exit 1
                        fi
                      else
                        echo "‚ùå Some imports failed"
                        echo ""
                        echo "üí° Manual fix needed:"
                        echo "   az group delete --name rg-network --yes --no-wait"
                        echo "   Then re-run this workflow"
                        exit 1
                      fi
                    else
                      # Different error
                      echo "‚ùå Terraform apply failed with non-import error"
                      exit 1
                    fi
                  fi
                  ;;
                  
                destroy)
                  if [ "$module" == "02-kubernetes" ]; then
                    terraform destroy -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                  else
                    terraform destroy -auto-approve
                  fi
                  ;;
              esac
              
              cd ../..
            done
          else
            # Deploy single module
            echo "========================================"
            echo "Deploying module: ${{ github.event.inputs.module }}"
            echo "========================================"
            cd terraform/${{ github.event.inputs.module }}
            
            terraform init
            
            # Handle different actions
            case "${{ github.event.inputs.action }}" in
              plan)
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  terraform plan -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                else
                  terraform plan
                fi
                ;;
                
              apply)
                # Attempt apply and capture output
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  APPLY_OUTPUT=$(terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}" 2>&1)
                else
                  APPLY_OUTPUT=$(terraform apply -auto-approve 2>&1)
                fi
                
                APPLY_EXIT=$?
                echo "$APPLY_OUTPUT"
                
                # Check if error is "already exists"
                if [ $APPLY_EXIT -ne 0 ]; then
                  if echo "$APPLY_OUTPUT" | grep -q "already exists.*needs to be imported"; then
                    echo ""
                    echo "‚ö†Ô∏è  'Already Exists' error detected!"
                    echo "üìã Multiple resources may need to be imported..."
                    echo ""
                    
                    # Extract ALL resources that need import
                    RESOURCES_TO_IMPORT=$(echo "$APPLY_OUTPUT" | grep -oP 'with \K[a-z_]+\.[a-z_]+(\[[^\]]+\])?' | sort -u)
                    RESOURCE_COUNT=$(echo "$RESOURCES_TO_IMPORT" | wc -l)
                    
                    echo "Found $RESOURCE_COUNT resource(s) that need import:"
                    echo "$RESOURCES_TO_IMPORT"
                    echo ""
                    
                    if [ $RESOURCE_COUNT -gt 5 ]; then
                      echo "‚ùå Too many resources to auto-import ($RESOURCE_COUNT resources)"
                      echo ""
                      echo "üí° This indicates orphaned resources from previous deployments."
                      echo "Quickest solution:"
                      echo "   1. az group delete --name rg-network --yes --no-wait"
                      echo "   2. Wait 3-5 minutes"
                      echo "   3. Re-run this workflow"
                      exit 1
                    fi
                    
                    # Try to import each resource
                    IMPORT_SUCCESS=true
                    while IFS= read -r RESOURCE_ADDRESS; do
                      if [ -z "$RESOURCE_ADDRESS" ]; then
                        continue
                      fi
                      
                      # Extract ID for this specific resource
                      RESOURCE_ID=$(echo "$APPLY_OUTPUT" | grep -A 2 "with $RESOURCE_ADDRESS" | grep -oP 'ID "\K[^"]+' | head -1)
                      
                      if [ -z "$RESOURCE_ID" ]; then
                        echo "‚ùå Failed to extract ID for: $RESOURCE_ADDRESS"
                        IMPORT_SUCCESS=false
                        continue
                      fi
                      
                      echo "üîÑ Importing: $RESOURCE_ADDRESS"
                      echo "   ID: $RESOURCE_ID"
                      
                      if terraform import "$RESOURCE_ADDRESS" "$RESOURCE_ID"; then
                        echo "‚úÖ Imported successfully!"
                      else
                        echo "‚ùå Import failed for: $RESOURCE_ADDRESS"
                        IMPORT_SUCCESS=false
                      fi
                      echo ""
                    done <<< "$RESOURCES_TO_IMPORT"
                    
                    if [ "$IMPORT_SUCCESS" = true ]; then
                      echo "‚úÖ All resources imported! Retrying apply..."
                      echo ""
                      
                      # Retry apply
                      if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                        terraform apply -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                      else
                        terraform apply -auto-approve
                      fi
                      
                      if [ $? -eq 0 ]; then
                        echo "‚úÖ Apply successful after import!"
                      else
                        echo "‚ùå Apply failed after import"
                        exit 1
                      fi
                    else
                      echo "‚ùå Some imports failed"
                      echo ""
                      echo "üí° Quick fix:"
                      echo "   az group delete --name rg-network --yes --no-wait"
                      echo "   Wait 3 minutes, then re-run this workflow"
                      exit 1
                    fi
                  else
                    # Different error
                    echo "‚ùå Terraform apply failed"
                    exit 1
                  fi
                fi
                ;;
                
              destroy)
                if [ "${{ github.event.inputs.module }}" == "02-kubernetes" ]; then
                  terraform destroy -auto-approve -var="deploy_clusters=${{ github.event.inputs.clusters }}"
                else
                  terraform destroy -auto-approve
                fi
                ;;
            esac
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Module: ${{ github.event.inputs.module }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Clusters: ${{ github.event.inputs.clusters }}"
          echo "Status: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              echo "‚úÖ Planning completed successfully!"
              echo ""
              echo "Review the plan above. If OK:"
              echo "  Run workflow again with action: apply"
            else
              echo "‚úÖ Infrastructure deployment completed successfully!"
              echo ""
              echo "Resources are now live in Azure."
            fi
          else
            echo "‚ùå Deployment failed."
            echo ""
            echo "üí° If you saw 'already exists' error, quickest fix:"
            echo "   1. Run: az group delete --name rg-network --yes --no-wait"
            echo "   2. Wait 3 minutes"
            echo "   3. Re-run this workflow"
            echo ""
            echo "üìö For permanent solution, see README.md 'Remote State Backend' section"
          fi
          echo ""
